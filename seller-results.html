<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Purchase Price Web Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.18/jspdf.plugin.autotable.min.js"></script>
    

</head>
<body>

    <div class="container mt-5">
        <h2 class="text-center">Property Purchase Price Form</h2>

        <!-- Google OAuth Login -->
        <div id="g_id_onload"
        data-client_id="257537625805-2rpqesq2t71bma08teuigaeqjdi65pph.apps.googleusercontent.com"
        data-callback="handleCredentialResponse"
        data-scope="profile email"
        data-auto_prompt="false"
        data-prompt_parent_id="g_id_signin">
        </div>
        <div class="g_id_signin" data-type="standard"></div>

        <!-- Data Capture Form -->
        <form id="propertyForm" class="mt-5">
            <h4>Owner Information</h4>
            <div class="mb-3">
                <label for="ownerFirstName" class="form-label">Owner First Name</label>
                <input type="text" class="form-control" id="ownerFirstName" placeholder="Enter owner first name" required>
            </div>
            <div class="mb-3">
                <label for="ownerLastName" class="form-label">Owner Last Name</label>
                <input type="text" class="form-control" id="ownerLastName" placeholder="Enter owner last name" required>
            </div>
            <div class="mb-3">
                <label for="ownerEmail" class="form-label">Owner Email Address</label>
                <input type="email" class="form-control" id="ownerEmail" placeholder="Enter owner email address" required>
            </div>
            <h4>Agent Information</h4>
            <div class="mb-3">
                <label for="agentFirstName" class="form-label">Agent First Name</label>
                <input type="text" class="form-control" id="agentFirstName" placeholder="Enter agent's first name" required>
            </div>
            <div class="mb-3">
                <label for="agentLastName" class="form-label">Agent Last Name</label>
                <input type="text" class="form-control" id="agentLastName" placeholder="Enter agent's last name" required>
            </div>
            <div class="mb-3">
                <label for="agentPhoneNumber" class="form-label">Agent Phone Number</label>
                <input type="tel" class="form-control" id="agentPhoneNumber" placeholder="Enter agent's phone number" required>
            </div>
        
            <h4>Offer Details</h4>
            <div class="mb-3">
                <label for="arv" class="form-label">ARV</label>
                <input type="number" class="form-control" id="arv" placeholder="Enter ARV" required>
            </div>
            <div class="mb-3">
                <label for="holdingPeriod" class="form-label">Holding Period (Months)</label>
                <input type="number" class="form-control" id="holdingPeriod" placeholder="Enter holding period in months" required>
            </div>
            <div class="mb-3">
                <label for="monthlyAssociationFees" class="form-label">Monthly Association Fees</label>
                <input type="number" class="form-control" id="monthlyAssociationFees" placeholder="Enter monthly association fees" required>
            </div>
            <div class="mb-3">
                <label for="annualTaxes" class="form-label">Annual Taxes</label>
                <input type="number" class="form-control" id="annualTaxes" placeholder="Enter annual taxes" required>
            </div>
            
            <h4>Property Information</h4>
            <div class="mb-3">
                <label for="propertyAddress" class="form-label">Property Address</label>
                <input type="text" class="form-control" id="propertyAddress" placeholder="Enter property address" required>
            </div>
            <div class="mb-3">
                <label for="propertyAddress" class="form-label">City, State ZIP</label>
                <input type="text" class="form-control" id="propertyCityStateZip" placeholder="Enter property address" required>
            </div>
            <div class="mb-3">
                <label for="livingSqFt" class="form-label">Living Square Footage</label>
                <input type="number" class="form-control" id="livingSqFt" placeholder="Enter living square footage" required>
            </div>
            <div class="mb-3">
                <label for="totalSqFt" class="form-label">Total Square Footage</label>
                <input type="number" class="form-control" id="totalSqFt" placeholder="Enter total square footage" required>
            </div>
            <div class="mb-3">
                <label for="lotSize" class="form-label">Lot Size (sq ft)</label>
                <input type="number" class="form-control" id="lotSize" placeholder="Enter lot size" required>
            </div>
            <div class="mb-3">
                <label for="bedrooms" class="form-label">Number of Bedrooms</label>
                <input type="number" class="form-control" id="bedrooms" placeholder="Enter number of bedrooms" required>
            </div>
           <div class="mb-3">
    <label for="bathrooms" class="form-label">Number of Bathrooms</label>
    <input type="number" class="form-control" id="bathrooms" placeholder="Enter number of bathrooms" required step="0.1">
</div>

            <h4>Property Features</h4>
            <div class="mb-3">
                <label class="form-label">Pool</label>
                <select class="form-select" id="pool">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Equipment</label>
                <select class="form-select" id="equipment">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Water Treatment</label>
                <select class="form-select" id="waterTreatment">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Tile</label>
                <select class="form-select" id="tile">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Resurface</label>
                <select class="form-select" id="resurface">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="windows" class="form-label">Number of Windows</label>
                <input type="number" class="form-control" id="windows" placeholder="Enter number of windows" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Electric</label>
                <select class="form-select" id="electric">
                    <option value="basic">Basic</option>
                    <option value="fullRenovation">Full Renovation</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Electric Panel Needed</label>
                <select class="form-select" id="electricPanel">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">AC Needed</label>
                <select class="form-select" id="acNeeded">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">AC Duct Work Needed</label>
                <select class="form-select" id="acDuctWork">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Landscaping Needed</label>
                <select class="form-select" id="landscapingNeeded">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Kitchen</label>
                <select class="form-select" id="kitchen">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Appliance (Full Package)</label>
                <select class="form-select" id="appliance">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Flooring</label>
                <select class="form-select" id="flooring">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Paint Interior</label>
                <select class="form-select" id="paintInterior">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Paint Exterior</label>
                <select class="form-select" id="paintExterior">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Roof</label>
                <select class="form-select" id="roof">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Other</label>
                <select class="form-select" id="other">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
        
            <h4>Additional Items</h4>
            <div class="mb-3">
                <label for="customRenovationAmount1" class="form-label">Additional Item 1 Amount ($)</label>
                <input type="number" class="form-control" id="customRenovationAmount1" placeholder="Enter amount">
            </div>
        
            <div class="mb-3">
                <label for="customRenovationAmount2" class="form-label">Additional Item 2 Amount ($)</label>
                <input type="number" class="form-control" id="customRenovationAmount2" placeholder="Enter amount">
            </div>
        
            <div class="mb-3">
                <label for="customRenovationAmount3" class="form-label">Additional Item 3 Amount ($)</label>
                <input type="number" class="form-control" id="customRenovationAmount3" placeholder="Enter amount">
            </div>

            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
    
        <!-- Modal -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Login Successful</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Welcome, you have successfully logged in with Google!</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        <div id="responseMessage"></div>

<!-- Modal To Display Agent Offer -->
<!-- Offer Presentation for Buying Agent Modal -->
<div class="modal fade" id="agentOfferModal" tabindex="-1" aria-labelledby="agentOfferLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="agentOfferLabel">Offer Presentation for Buying Agent</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Client:</strong> <span id="clientNameAgent"></span></p>
          <p><strong>Property Address:</strong> <span id="propertyAddressAgent"></span></p>
          <p><strong>ARV:</strong> <span id="arvAgent"></span></p>
          <p><strong>Holding Period (months):</strong> <span id="holdingPeriodAgent"></span></p>
          <p><strong>Monthly Association Fees:</strong> <span id="associationFeesAgent"></span></p>
          <p><strong>Annual Taxes:</strong> <span id="annualTaxesAgent"></span></p>
          <p><strong>Retail Buying Offer:</strong> <span id="retailOfferAgent"></span></p>
          <p><strong>Percentage of ARV:</strong> <span id="percentageArvAgent"></span></p>
          <p><strong>Wholesale Buying Offer:</strong> <span id="wholesaleOfferAgent"></span></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="downloadAgentOffer">Download Offer PDF</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Button to trigger the modal -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agentOfferModal">
    View Offer for Buying Agent
  </button>
  

  <!-- Modal for Offer Presentation to Seller -->
<div class="modal fade" id="sellerOfferModal" tabindex="-1" aria-labelledby="sellerOfferLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sellerOfferLabel">Offer Presentation for Seller</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table">
            <tr>
              <th>Client</th>
              <td id="sellerClientName"></td>
            </tr>
            <tr>
                <th>Property Address</th>
                <td id="sellerPropertyAddress"></td>
              </tr>
              <tr>
                <th>City, State ZIP</th>
                <td id="sellerPropertyCityStateZip"></td>
              </tr>
              <tr>
                <th>Offer Date</th>
                <td id="sellerOfferDate"></td>
              </tr>
            <tr>
              <th>Cash Offer</th>
              <td id="sellerCashOffer"></td>
            </tr>
            <tr>
              <th>Other Sale Options</th>
              <th>Retail Sale - After Repairs</th>
              <th>Retail Sale - As Is</th>
            </tr>
            <tr>
              <th>Market Value</th>
              <td id="sellerMarketValueAfterRepairs"></td>
              <td id="sellerMarketValueAsIs"></td>
            </tr>
            <tr>
              <th>Costs to Achieve Value</th>
              <td colspan="2"></td>
            </tr>
            <tr>
              <th>Selling Commission and Costs</th>
              <td id="sellerCommissionAfterRepairs"></td>
              <td id="sellerCommissionAsIs"></td>
            </tr>
            <tr>
              <th>Repairs to Achieve Market Value</th>
              <td id="sellerRequiredRepairs"></td>
              <td>Not Applicable</td>
            </tr>
            <tr>
              <th>Opportunity Cost of foregoing cash offer</th>
              <td id="sellerOpportunityCostAfterRepairs"></td>
              <td id="sellerOpportunityCostAsIs"></td>
            </tr>
            <tr>
              <th>Association Fees</th>
              <td id="sellerAssociationFeesAfterRepairs"></td>
              <td id="sellerAssociationFeesAsIs"></td>
            </tr>
            <tr>
              <th>Taxes</th>
              <td id="sellerTaxesAfterRepairs"></td>
              <td id="sellerTaxesAsIs"></td>
            </tr>
            <tr>
              <th>Total Costs</th>
              <td id="sellerTotalCostsAfterRepairs"></td>
              <td id="sellerTotalCostsAsIs"></td>
            </tr>
            <tr>
              <th>Net to You</th>
              <td id="sellerNetAfterRepairs"></td>
              <td id="sellerNetAsIs"></td>
            </tr>
          </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="downloadWholesalePDF">Download Wholesale Presentation</button>
            <button type="button" class="btn btn-primary" id="downloadRetailPDF">Download Retail Presentation</button>
          </div>
          
      </div>
    </div>
  </div>
  
  <!-- Button to trigger the seller offer modal -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sellerOfferModal">
    View Offer for Seller
  </button>
  <button type="button" class="btn btn-danger" id="downloadWholesaleOfferLetter">Download Wholesale Offer Letter</button>
  <button type="button" class="btn btn-danger" id="downloadRetailOfferLetter">Download Retail Offer Letter</button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
   
// Store access token globally
let accessToken;

// Function to handle the Google OAuth login and retrieve the access token
function handleCredentialResponse(response) {
    // Redirect to Google's authorization endpoint for OAuth login
    const oauth2Url = `https://accounts.google.com/o/oauth2/v2/auth?client_id=257537625805-2rpqesq2t71bma08teuigaeqjdi65pph.apps.googleusercontent.com&redirect_uri=http://localhost:5500/pricing_tool.html&response_type=code&scope=https://www.googleapis.com/auth/spreadsheets`;
    window.location.href = oauth2Url;  // Redirect the user to the consent page
}

// Get the authorization code from the URL after the user has been redirected back
function getAuthorizationCodeFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('code');  // Extract 'code' parameter from the URL
}

// Exchange the authorization code for an OAuth access token
function exchangeAuthorizationCodeForAccessToken(authorizationCode) {
    const tokenEndpoint = 'https://oauth2.googleapis.com/token';

    const params = new URLSearchParams({
        client_id: '257537625805-2rpqesq2t71bma08teuigaeqjdi65pph.apps.googleusercontent.com',
        client_secret: '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',  // Replace with actual client secret
        grant_type: 'authorization_code',
        redirect_uri: 'http://localhost:5500/pricing_tool.html',  // Ensure this matches Google Cloud settings
        code: authorizationCode  // Use the authorization code from the URL
    });

    // Make a POST request to exchange the authorization code for the access token
    fetch(tokenEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params.toString()
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(`Token exchange failed: ${errorData.error}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.access_token) {
            accessToken = data.access_token;
            console.log('Access Token:', accessToken);
            showLoginSuccessModal();
            clearUrlParams();
        }
    })
    .catch(error => {
        console.error('Error during token exchange:', error);
        showErrorMessage('Failed to retrieve access token: ' + error.message);
    });
}

// Function to show login success modal
function showLoginSuccessModal() {
    var loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
    loginModal.show();
    document.querySelector('.g_id_signin').style.display = 'none';
    google.accounts.id.disableAutoSelect();
}

// Function to show error message
function showErrorMessage(message) {
    document.getElementById('responseMessage').innerHTML = `<div class="alert alert-danger">${message}</div>`;
}

// Function to clear the URL parameters after successful token exchange
function clearUrlParams() {
    const newUrl = window.location.origin + window.location.pathname;
    window.history.pushState({}, document.title, newUrl);  // Clear query params like 'code'
}

// Initialize Google OAuth Login
window.onload = function() {
    // Initialize the Google OAuth Client
    google.accounts.id.initialize({
        client_id: '257537625805-2rpqesq2t71bma08teuigaeqjdi65pph.apps.googleusercontent.com',
        callback: handleCredentialResponse,
        error_callback: (error) => {
            console.error("Error in OAuth flow:", error);
            alert("An error occurred during sign-in. Please try again.");
        }
    });

    // Render the Google Sign-In button
    google.accounts.id.renderButton(
        document.querySelector('.g_id_signin'),
        { theme: 'outline', size: 'large' }
    );

    // Check for an authorization code in the URL (after redirect)
    const authorizationCode = getAuthorizationCodeFromUrl();
    if (authorizationCode) {
        // If authorization code is available, exchange it for an access token
        exchangeAuthorizationCodeForAccessToken(authorizationCode);
    } else {
        // If no authorization code, automatically prompt the user to log in
        google.accounts.id.prompt();
    }

    // Add fallback check for whether third-party cookies are disabled
    checkForThirdPartyCookies();
};

// Function to check if third-party cookies are enabled
function checkForThirdPartyCookies() {
    try {
        document.cookie = "testcookie=test; SameSite=None; Secure";
        if (document.cookie.indexOf("testcookie") === -1) {
            alert("Third-party cookies are disabled. Please enable them for this application to work.");
        } else {
            console.log("Third-party cookies are enabled.");
        }
    } catch (e) {
        console.error("Error checking cookies:", e);
        alert("Your browser settings may prevent this functionality. Please ensure third-party cookies are enabled.");
    }
}


// Form Submission Handler
document.getElementById('propertyForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const formData = {
        ownerFirstName: document.getElementById('ownerFirstName').value,
        ownerLastName: document.getElementById('ownerLastName').value,
        ownerEmail: document.getElementById('ownerEmail').value,
        agentFirstName: document.getElementById('agentFirstName').value,
        agentLastName: document.getElementById('agentLastName').value,
        agentPhoneNumber: document.getElementById('agentPhoneNumber').value,
        propertyAddress: document.getElementById('propertyAddress').value,
        propertyCityStateZip: document.getElementById('propertyCityStateZip').value,
        totalSqFt: document.getElementById('totalSqFt').value,
        livingSqFt: document.getElementById('livingSqFt').value,
        lotSize: document.getElementById('lotSize').value,
        bedrooms: document.getElementById('bedrooms').value,
        bathrooms: document.getElementById('bathrooms').value,
        pool: document.getElementById('pool').value,
        equipment: document.getElementById('equipment').value,
        waterTreatment: document.getElementById('waterTreatment').value,
        tile: document.getElementById('tile').value,
        resurface: document.getElementById('resurface').value,
        windows: document.getElementById('windows').value,
        electric: document.getElementById('electric').value,
        electricPanel: document.getElementById('electricPanel').value,
        acNeeded: document.getElementById('acNeeded').value,
        acDuctWork: document.getElementById('acDuctWork').value,
        landscapingNeeded: document.getElementById('landscapingNeeded').value,
        kitchen: document.getElementById('kitchen').value,
        appliance: document.getElementById('appliance').value,
        flooring: document.getElementById('flooring').value,
        paintInterior: document.getElementById('paintInterior').value,
        paintExterior: document.getElementById('paintExterior').value,
        roof: document.getElementById('roof').value,
        other: document.getElementById('other').value,
        customRenovationAmount1: document.getElementById('customRenovationAmount1').value,
        customRenovationAmount2: document.getElementById('customRenovationAmount2').value,
        customRenovationAmount3: document.getElementById('customRenovationAmount3').value,
        // Offer specific data
        arv: document.getElementById('arv').value,
        holdingPeriod: document.getElementById('holdingPeriod').value,
        monthlyAssociationFees: document.getElementById('monthlyAssociationFees').value,
        annualTaxes: document.getElementById('annualTaxes').value
    };
// Add this line to log the form data
console.log('Form Data:', formData);
    if (accessToken) {
        // Send data to both sheets
        Promise.all([
            sendDataToGoogleSheets(formData, accessToken),
            sendDataToOfferSheet(formData, accessToken)
        ]).then(() => {
            // Wait for 2 seconds to allow spreadsheet calculations to complete
            setTimeout(() => {
                fetchAndPopulateSellerOffer(accessToken, formData);
            }, 2000);
        }).catch(error => {
            console.error('Error during data submission:', error);
            alert('An error occurred while submitting the data. Please try again.');
        });
    } else {
        alert('You need to log in first.');
    }
});

function sendDataToOfferSheet(data, accessToken) {
    const spreadsheetId = '1RsJO6oJpA0-e2FeifhYSXsY2qXPb2np10hjFUs3HYuQ';
    const range = 'Offer!B7:B14';  // Updated range to exclude property address
    
    const values = [
        [data.arv],                                       // B7 - ARV
        [],                                       // B8 - As Is Market Value (same as ARV)
        [data.holdingPeriod],                             // B9 - Holding Period (months)
        [],                                               // B10
        [],                                               // B11
        [],                                               // B12
        [data.monthlyAssociationFees],                    // B13 - Monthly Association Fees
        [data.annualTaxes]                                // B14 - Annual Taxes
    ];

    const body = {
        values: values
    };

    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?valueInputOption=USER_ENTERED`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
    })
    .then(response => {
        console.log('Response Status:', response.status);
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Error response from Google Sheets API:', text);
                throw new Error(`Failed to send data: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(result => {
        console.log('Data successfully sent to the Offer sheet:', result);
        document.getElementById('responseMessage').innerHTML += '<p>Offer data submitted successfully!</p>';
        // Fetch the offer results after the calculations are done
        fetchOfferResults(accessToken, data);
        // Show the modal after fetching the results
        setTimeout(() => {
            var agentOfferModal = new bootstrap.Modal(document.getElementById('agentOfferModal'));
            agentOfferModal.show();
        }, 1000); // Wait for 1 second to ensure data is fetched
    })
    .catch(error => {
        console.error('Error sending data to the Offer sheet:', error);
        document.getElementById('responseMessage').innerHTML += '<p>Error submitting offer data: ' + error.message + '</p>';
    });
}


// function to send data to rehab estimation sheet
function sendDataToGoogleSheets(data, accessToken) {
    const spreadsheetId = '1RsJO6oJpA0-e2FeifhYSXsY2qXPb2np10hjFUs3HYuQ';
    const range = 'Rehab Estimation!B1:B35';  // Range covers only column B

    // Map form data to spreadsheet cells
    const values = [
        [data.propertyAddress],  // B1
        [data.totalSqFt],        // B2
        [data.livingSqFt],       // B3
        [data.lotSize],          // B4
        [],                      // B5 (empty)
        [],                      // B6 (empty)
        [],                      // B7 (empty)
        [],                      // B8 (empty)
        [data.propertyAddress],  // B9
        [data.bedrooms],         // B10
        [data.bathrooms],        // B11
        [data.livingSqFt],       // B12
        [data.totalSqFt],        // B13
        [data.lotSize],          // B14
        [data.pool],             // B15
        [data.equipment],        // B16
        [data.waterTreatment],   // B17
        [data.tile],             // B18
        [data.resurface],        // B19
        [data.windows],          // B20
        [data.electric],         // B21
        [data.electricPanel],    // B22
        [data.acNeeded],         // B23
        [data.acDuctWork],       // B24
        [data.landscapingNeeded],// B25
        [data.kitchen],          // B26
        [data.appliance],        // B27
        [data.flooring],         // B28
        [data.paintInterior],    // B29
        [data.paintExterior],    // B30
        [data.roof],             // B31
        [data.other],            // B32
        [data.customRenovationAmount1],  // B33
        [data.customRenovationAmount2],  // B34
        [data.customRenovationAmount3]   // B35
    ];

    const body = {
        values: values
    };

    console.log('Sending data to Google Sheets:', body);

    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?valueInputOption=USER_ENTERED`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
    })
    .then(response => {
        console.log('Response Status:', response.status);
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Error response from Google Sheets API:', text);
                throw new Error(`Failed to send data: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(result => {
        console.log('Data successfully sent to Google Sheets:', result);
        document.getElementById('responseMessage').innerHTML = 'Data submitted successfully!';
        // After successful submission, fetch the calculated results
        fetchCalculatedResults(accessToken);
    })
    .catch(error => {
        console.error('Error sending data to Google Sheets:', error);
        document.getElementById('responseMessage').innerHTML = 'Error submitting data: ' + error.message;
    });
}

 // Fetch Calculated Results from Google Sheets
 function fetchCalculatedResults(accessToken) {
    const spreadsheetId = '1RsJO6oJpA0-e2FeifhYSXsY2qXPb2np10hjFUs3HYuQ';
    const range = 'Rehab Estimation!E32:F34'; // Include sheet name in the range

    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Error response from Google Sheets API:', text);
                throw new Error(`Failed to fetch data: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(result => {
        console.log('Fetched results:', result);
        if (result.values && result.values.length >= 3) {
            const contractorFeeOurCost = result.values[0][0] || 'N/A'; // E32
            const contractorFeeRetailCost = result.values[0][1] || 'N/A'; // F32
            const grandTotalOurCost = result.values[2][0] || 'N/A'; // E34
            const grandTotalRetailCost = result.values[2][1] || 'N/A'; // F34

            document.getElementById('responseMessage').innerHTML += `
                <h3>Calculated Results:</h3>
                <p>Contractor Fee (Our Cost): ${contractorFeeOurCost}</p>
                <p>Contractor Fee (Retail Cost): ${contractorFeeRetailCost}</p>
                <p>Grand Total (Our Cost): ${grandTotalOurCost}</p>
                <p>Grand Total (Retail Cost): ${grandTotalRetailCost}</p>
            `;
        } else {
            document.getElementById('responseMessage').innerHTML += '<p>No results available.</p>';
        }
    })
    .catch(error => {
        console.error('Error fetching results from Google Sheets:', error);
        document.getElementById('responseMessage').innerHTML += '<p>Error fetching results: ' + error.message + '</p>';
    });
}

// Fetch Calculated Offer Results from Google Sheets
function fetchOfferResults(accessToken, formData) {
    const spreadsheetId = '1RsJO6oJpA0-e2FeifhYSXsY2qXPb2np10hjFUs3HYuQ';
    const range = 'Offer!B7:E23';  // Updated range to include all needed cells

    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to fetch data: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Fetched Offer Data:', result.values);
        
        if (result.values && result.values.length >= 17) {
            offerData = {
                clientName: `${formData.ownerFirstName} ${formData.ownerLastName}`,
                agentFirstName: formData.agentFirstName,
                agentLastName: formData.agentLastName,
                agentPhoneNumber: formData.agentPhoneNumber,
                propertyAddress: formData.propertyAddress,
                propertyCityStateZip: formData.propertyCityStateZip,
                arv: result.values[0][0] || 'N/A',
                holdingPeriod: result.values[2][0] || 'N/A',
                monthlyAssociationFees: result.values[6][0] || 'N/A',
                annualTaxes: result.values[7][0] || 'N/A',
                retailBuyingOffer: result.values[4][3] || 'N/A',
                percentageArv: result.values[7][3] || 'N/A',
                wholesaleBuyingOffer: result.values[16][3] || 'N/A'
            };

            console.log('Updated offerData:', offerData);

            // Populate the modal with the fetched data
            populateAgentOfferModal(offerData);

            // Show the modal after fetching the results
            setTimeout(() => {
                var agentOfferModal = new bootstrap.Modal(document.getElementById('agentOfferModal'));
                agentOfferModal.show();
            }, 1000); // Wait for 1 second to ensure data is fetched
        } else {
            throw new Error('Insufficient data received from the spreadsheet');
        }
    })
    .catch(error => {
        console.error('Error fetching offer results:', error);
        alert('Error fetching offer results: ' + error.message);
    });
}

// Javascript to populate Modal
function populateAgentOfferModal(data) {
    document.getElementById('clientNameAgent').innerText = data.clientName;
    document.getElementById('propertyAddressAgent').innerText = data.propertyAddress;
    document.getElementById('arvAgent').innerText = data.arv;
    document.getElementById('holdingPeriodAgent').innerText = data.holdingPeriod;
    document.getElementById('associationFeesAgent').innerText = data.monthlyAssociationFees;
    document.getElementById('annualTaxesAgent').innerText = data.annualTaxes;
    document.getElementById('retailOfferAgent').innerText = data.retailBuyingOffer;
    document.getElementById('percentageArvAgent').innerText = data.percentageArv;
    document.getElementById('wholesaleOfferAgent').innerText = data.wholesaleBuyingOffer;

}


let offerData; // Global variable to store the offer data

function fetchAndPopulateSellerOffer(accessToken, formData) {
    const spreadsheetId = '1RsJO6oJpA0-e2FeifhYSXsY2qXPb2np10hjFUs3HYuQ';
    const range = 'Offer!A1:L35';  // Range includes all necessary columns

    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to fetch data: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('Fetched results for seller offer:', result);
        
        if (result.values && result.values.length > 0) {
            offerData = processSellerOfferData(result.values, formData);
            populateSellerOfferModal(offerData);
            showSellerOfferModal();
            setupPDFDownloadListeners(); // Set up listeners after data is fetched
        } else {
            throw new Error('Insufficient data received from the spreadsheet');
        }
    })
    .catch(error => {
        console.error('Error fetching seller offer data:', error);
        showErrorMessage('Error fetching offer data: ' + error.message);
    });
}


// Function to process seller offer data
function processSellerOfferData(values, formData) {
    const getValue = (row, col) => (values[row] && values[row][col]) ? values[row][col] : 'N/A';

    const data = {
        clientName: `${formData.ownerFirstName} ${formData.ownerLastName}`,
        propertyAddress: formData.propertyAddress,
        propertyCityStateZip: formData.propertyCityStateZip,
        agentFirstName: formData.agentFirstName,
        agentLastName: formData.agentLastName,
        agentPhoneNumber: formData.agentPhoneNumber,
        retailBuyPrice: getValue(10, 4),  // E11 - Retail Buy Price
        wholesaleBuyingOffer: getValue(22, 4),  // E23 - Target Wholesale Buy Price
        marketValueAfterRepairs: getValue(6, 1),  // B7 - ARV
        marketValueAsIs: getValue(8, 11),  // L9 - Market Value (As Is)
        
        // Retail Sale - After Repairs
        commissionAfterRepairs: getValue(10, 10),  // K11 - Selling Commission and Costs (Repairs)
        requiredRepairsAfterRepairs: getValue(11, 10),  // K12 - Repairs to achieve market value
        opportunityCostAfterRepairs: getValue(12, 10),  // K13 - Opportunity Cost (Repairs)
        associationFeesAfterRepairs: getValue(13, 10),  // K14 - Association Fees (Repairs)
        taxesAfterRepairs: getValue(14, 10),  // K15 - Taxes (Repairs)
        
        // Retail Sale - As Is
        commissionAsIs: getValue(10, 11),  // L11 - Selling Commission and Costs (As Is)
        opportunityCostAsIs: getValue(12, 11),  // L13 - Opportunity Cost (As Is)
        associationFeesAsIs: getValue(13, 11),  // L14 - Association Fees (As Is)
        taxesAsIs: getValue(14, 11),  // L15 - Taxes (As Is)
    };

    // Calculate total costs
    data.totalCostsAfterRepairs = calculateTotalCosts([
        data.commissionAfterRepairs,
        data.requiredRepairsAfterRepairs,
        data.opportunityCostAfterRepairs,
        data.associationFeesAfterRepairs,
        data.taxesAfterRepairs
    ]);

    data.totalCostsAsIs = calculateTotalCosts([
        data.commissionAsIs,
        data.opportunityCostAsIs,
        data.associationFeesAsIs,
        data.taxesAsIs
    ]);

    // Calculate Net To You
    data.netAfterRepairs = calculateNetToYou(data.marketValueAfterRepairs, data.totalCostsAfterRepairs);
    data.netAsIs = calculateNetToYou(data.marketValueAsIs, data.totalCostsAsIs);

    console.log('Processed data for seller offer:', data);
    return data;
}

// Function to populate seller offer modal
function populateSellerOfferModal(data) {
    const elements = {
        sellerClientName: data.clientName,
        sellerPropertyAddress: data.propertyAddress,
        sellerPropertyCityStateZip: data.propertyCityStateZip, 
        sellerOfferDate: new Date().toLocaleDateString(), // Today's date
        sellerMarketValueAfterRepairs: formatCurrency(data.marketValueAfterRepairs),
        sellerMarketValueAsIs: formatCurrency(data.marketValueAsIs),
        sellerCommissionAfterRepairs: formatCurrency(data.commissionAfterRepairs),
        sellerCommissionAsIs: formatCurrency(data.commissionAsIs),
        sellerRequiredRepairs: formatCurrency(data.requiredRepairsAfterRepairs),
        sellerOpportunityCostAfterRepairs: formatCurrency(data.opportunityCostAfterRepairs),
        sellerOpportunityCostAsIs: formatCurrency(data.opportunityCostAsIs),
        sellerAssociationFeesAfterRepairs: formatCurrency(data.associationFeesAfterRepairs),
        sellerAssociationFeesAsIs: formatCurrency(data.associationFeesAsIs),
        sellerTaxesAfterRepairs: formatCurrency(data.taxesAfterRepairs),
        sellerTaxesAsIs: formatCurrency(data.taxesAsIs),
        sellerTotalCostsAfterRepairs: formatCurrency(data.totalCostsAfterRepairs),
        sellerTotalCostsAsIs: formatCurrency(data.totalCostsAsIs),
        sellerNetAfterRepairs: formatCurrency(data.netAfterRepairs),
        sellerNetAsIs: formatCurrency(data.netAsIs)
    };

    for (const [id, value] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value || 'N/A';
        } else {
            console.warn(`Element with id ${id} not found`);
        }
    }
    // Display cash offer options
    const cashOfferElement = document.getElementById('sellerCashOffer');
    if (cashOfferElement) {
        cashOfferElement.innerHTML = `
            <p>Retail Buy Price: ${formatCurrency(data.retailBuyPrice)}</p>
            <p>Target Wholesale Price: ${formatCurrency(data.wholesaleBuyingOffer)}</p>
        `;
    } else {
        console.warn('Element with id sellerCashOffer not found');
    }
}

// Helper function to format currency
function formatCurrency(value) {
    if (value === 'N/A' || value == null) return 'N/A';
    const numValue = parseFloat(value.replace(/[^0-9.-]+/g,""));
    return isNaN(numValue) ? 'N/A' : `$${numValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
}

// Helper function to calculate total costs
function calculateTotalCosts(costs) {
    return costs.reduce((total, cost) => {
        const value = parseFloat(cost.replace(/[^0-9.-]+/g,""));
        return isNaN(value) ? total : total + value;
    }, 0).toFixed(2);
}

// Helper function to calculate Net To You
function calculateNetToYou(marketValue, totalCosts) {
    const mvValue = parseFloat(marketValue.replace(/[^0-9.-]+/g,""));
    const tcValue = parseFloat(totalCosts);
    return isNaN(mvValue) || isNaN(tcValue) ? 'N/A' : (mvValue - tcValue).toFixed(2);
}


// Function to show seller offer modal
function showSellerOfferModal() {
    const modalElement = document.getElementById('sellerOfferModal');
    if (modalElement) {
        const sellerOfferModal = new bootstrap.Modal(modalElement);
        sellerOfferModal.show();
    } else {
        console.error('Seller offer modal element not found');
        showErrorMessage('Unable to display the offer. Please try again.');
    }
}

// Function to show error message
function showErrorMessage(message) {
    const errorElement = document.getElementById('errorMessage');
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    } else {
        console.error('Error message element not found');
        alert(message);
    }
}

// Generate the PDF for Seller Presentation
function setupPDFDownloadListeners() {
    // Existing listeners
    document.getElementById('downloadWholesalePDF').addEventListener('click', function() {
        generatePDF('Wholesale');
    });

    document.getElementById('downloadRetailPDF').addEventListener('click', function() {
        generatePDF('Retail');
    });

    document.getElementById('downloadWholesaleOfferLetter').addEventListener('click', function() {
        generateOfferLetterPDF('Wholesale');
    });

    document.getElementById('downloadRetailOfferLetter').addEventListener('click', function() {
        generateOfferLetterPDF('Retail');
    });

    // Updated listener for Buying Agent Offer PDF
    document.getElementById('downloadAgentOffer').addEventListener('click', function() {
        generateBuyingAgentPDF();
    });
}

async function generatePDF(type) {
    console.log(`Generating ${type} PDF`);
    if (!offerData) {
        console.error('Offer data is not available');
        alert('Unable to generate PDF. Please try submitting the form again.');
        return;
    }

    const logoUrl = '/images/OldR3-logo.jpeg';
    const logoDataUrl = await getImageDataUrl(logoUrl);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 10;

    // Set document properties
    doc.setProperties({
        title: `${type} Presentation for ${offerData.clientName}`,
        subject: 'Property Offer',
        author: 'OldR3',
        keywords: 'real estate, offer, property',
        creator: 'OldR3'
    });

    // Add logo
    doc.addImage(logoDataUrl, 'JPEG', margin, 5, 40, 20);

    // Header
    doc.setFillColor(39, 174, 96);
    doc.rect(0, 30, pageWidth, 15, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("OldR3", pageWidth / 2, 38, { align: "center" });
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.text("123 Real Estate St, City, State 12345 | (123) 456-7890 | www.oldr3.com", pageWidth / 2, 43, { align: "center" });

    // Title and Client Info
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text(`${type} Presentation for Seller`, margin, 55);

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Client: ${offerData.clientName}`, margin, 62);
    doc.text(`Property Address: ${offerData.propertyAddress}`, margin, 68);
    doc.text(offerData.propertyCityStateZip, margin, 74);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, 80);

    // Offer Price
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    const priceText = type === 'Wholesale' ? 
        `Target Wholesale Price: ${formatCurrency(offerData.wholesaleBuyingOffer)}` :
        `Retail Buy Price: ${formatCurrency(offerData.retailBuyPrice)}`;
    doc.text(priceText, margin, 90);

    // Table
    const startY = 95;
    const headers = [["Other Sale Options", "Retail Sale - After Repairs", "Retail Sale - As Is"]];
    const rows = [
        ["Market Value", formatCurrency(offerData.marketValueAfterRepairs), formatCurrency(offerData.marketValueAsIs)],
        [{ content: "Costs to Achieve Value", colSpan: 3, styles: { fillColor: [39, 174, 96], textColor: 255, fontStyle: 'bold' } }],
        ["Selling Commission and Costs", formatCurrency(offerData.commissionAfterRepairs), formatCurrency(offerData.commissionAsIs)],
        ["Repairs to Achieve Market Value", formatCurrency(offerData.requiredRepairsAfterRepairs), "Not Applicable"],
        ["Opportunity Cost of foregoing cash offer", formatCurrency(offerData.opportunityCostAfterRepairs), formatCurrency(offerData.opportunityCostAsIs)],
        ["Association Fees", formatCurrency(offerData.associationFeesAfterRepairs), formatCurrency(offerData.associationFeesAsIs)],
        ["Taxes", formatCurrency(offerData.taxesAfterRepairs), formatCurrency(offerData.taxesAsIs)],
        ["Total Costs", formatCurrency(offerData.totalCostsAfterRepairs), formatCurrency(offerData.totalCostsAsIs)],
        ["Net to You", formatCurrency(offerData.netAfterRepairs), formatCurrency(offerData.netAsIs)]
    ];

    doc.autoTable({
        startY: startY,
        head: headers,
        body: rows,
        theme: 'grid',
        headStyles: { fillColor: [39, 174, 96], textColor: 255, fontStyle: 'bold', fontSize: 8 },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
            0: { cellWidth: 70 },
            1: { cellWidth: 55 },
            2: { cellWidth: 55 }
        },
        styles: { 
            cellPadding: 2,
            lineColor: [200, 200, 200],
            lineWidth: 0.1,
        },
        alternateRowStyles: { fillColor: [240, 240, 240] },
        margin: { left: margin, right: margin },
        didParseCell: function(data) {
            if (data.section === 'head' || (data.row.raw[0] && data.row.raw[0].styles)) {
                data.cell.styles.fillColor = [39, 174, 96];
                data.cell.styles.textColor = 255;
                data.cell.styles.fontStyle = 'bold';
            }
        }
    });

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(`Page 1 of 1`, pageWidth / 2, pageHeight - 10, { align: "center" });
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, pageWidth / 2, pageHeight - 5, { align: "center" });

    // Save the PDF
    doc.save(`${type}_Presentation_${offerData.clientName.replace(/\s+/g, '_')}.pdf`);
}

// Function to convert image to data URL
async function getImageDataUrl(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = this.width;
            canvas.height = this.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(this, 0, 0);
            resolve(canvas.toDataURL('image/jpeg'));
        };
        img.onerror = reject;
        img.src = url;
    });
}


// Generate agent offer PDF

async function generateBuyingAgentPDF() {
    console.log("Generating Buying Agent PDF");

    // Gather data directly from the modal
    const modalData = {
        clientName: document.getElementById('clientNameAgent').innerText,
        propertyAddress: document.getElementById('propertyAddressAgent').innerText,
        arv: document.getElementById('arvAgent').innerText,
        holdingPeriod: document.getElementById('holdingPeriodAgent').innerText,
        monthlyAssociationFees: document.getElementById('associationFeesAgent').innerText,
        annualTaxes: document.getElementById('annualTaxesAgent').innerText,
        retailBuyingOffer: document.getElementById('retailOfferAgent').innerText,
        percentageArv: document.getElementById('percentageArvAgent').innerText,
        wholesaleBuyingOffer: document.getElementById('wholesaleOfferAgent').innerText
    };

    console.log("Modal Data for PDF:", modalData);

    const logoUrl = '/images/OldR3-logo.jpeg';
    const logoDataUrl = await getImageDataUrl(logoUrl);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 20;

    // Add logo
    doc.addImage(logoDataUrl, 'JPEG', margin, 10, 40, 20);

    // Add header
    doc.setFillColor(39, 174, 96);
    doc.rect(0, 35, pageWidth, 15, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("OldR3", pageWidth / 2, 43, { align: "center" });
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.text("123 Real Estate St, City, State 12345 | (123) 456-7890 | www.oldr3.com", pageWidth / 2, 48, { align: "center" });

    // Title
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text("Offer Presentation for Buying Agent", margin, 60);

    // Offer details table
    const startY = 70;
    const headers = [["Item", "Value"]];
    const rows = Object.entries(modalData).map(([key, value]) => [key, value || 'N/A']);

    doc.autoTable({
        startY: startY,
        head: headers,
        body: rows,
        theme: 'grid',
        headStyles: { fillColor: [39, 174, 96], textColor: 255, fontStyle: 'bold' },
        styles: { cellPadding: 5, fontSize: 10 },
        columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 80 } },
    });

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(`Page 1 of 1`, pageWidth / 2, pageHeight - 10, { align: "center" });
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, pageWidth / 2, pageHeight - 5, { align: "center" });

    // Save the PDF
    doc.save(`Buying_Agent_Presentation_${modalData.clientName.replace(/\s+/g, '_')}.pdf`);
}


// Generate Offer Letter
async function generateOfferLetterPDF(type) {
    console.log(`Generating ${type} Offer Letter PDF`);
    if (!offerData) {
        console.error('Offer data is not available');
        alert('Unable to generate PDF. Please try submitting the form again.');
        return;
    }

    const logoUrl = '/images/OldR3-logo.jpeg'; // Update this to your logo path or URL
    const logoDataUrl = await getImageDataUrl(logoUrl);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 20;

    // Add logo
    doc.addImage(logoDataUrl, 'JPEG', margin, 10, 40, 20);

    // Add header
    doc.setFillColor(39, 174, 96); // A softer green
    doc.rect(0, 35, pageWidth, 15, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("OldR3", pageWidth / 2, 43, { align: "center" });
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.text("123 Real Estate St, City, State 12345 | (123) 456-7890 | www.oldr3.com", pageWidth / 2, 48, { align: "center" });

    // Reset text color for main content
    doc.setTextColor(0, 0, 0);

    // Set font styles
    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);

    // Add recipient address
    doc.text(`${offerData.clientName}`, margin, 65);
    doc.text(`${offerData.propertyAddress}`, margin, 75);
    doc.text(`${offerData.propertyCityStateZip}`, margin, 85);

    // Add letter content
    doc.text(`Dear ${offerData.clientName.split(' ')[0]},`, margin, 105);

    doc.setFontSize(10);
    let yPos = 115;
    const lineHeight = 7;

    const paragraphs = [
        "Thank you for your consideration of our offer to purchase your property. Home Ventures has been helping homeowners with their real estate needs for over 20 years. We are happy to provide you with the following offer for your property:",
        `Cash purchase price: ${type === 'Wholesale' ? formatCurrency(offerData.wholesaleBuyingOffer) : formatCurrency(offerData.retailBuyPrice)}`,
        `Cash offer date: ${new Date().toLocaleDateString()}`,
        `When you buy from us you pay no real estate commissions or closing costs. That could represent a savings of ${formatCurrency(offerData.commissionAsIs)}. We can close in as quickly as 10 days or at a date of your choosing. Our offer is good for 7 days from the date of this written offer.`,
        "We look forward to hearing back from your promptly.",
        "Thank you,",
        `${offerData.agentFirstName} ${offerData.agentLastName}`,
        `${offerData.agentPhoneNumber}`
    ];

    paragraphs.forEach((paragraph, index) => {
        const lines = doc.splitTextToSize(paragraph, pageWidth - 2 * margin);
        doc.text(lines, margin, yPos);
        yPos += lines.length * lineHeight + (index === 1 || index === 2 || index === 5 ? lineHeight : 0);
    });

    // Add footer
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(`Page 1 of 1`, pageWidth / 2, pageHeight - 15, { align: "center" });
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, pageWidth / 2, pageHeight - 10, { align: "center" });

    // Save the PDF
    doc.save(`${type}_Offer_Letter_${offerData.clientName.replace(/\s+/g, '_')}.pdf`);
}
    </script>
    
    
</body>
</html>
